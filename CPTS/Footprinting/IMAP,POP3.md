# IMAP / POP3

ด้วยความช่วยเหลือของ **Internet Message Access Protocol (IMAP)** เราสามารถเข้าถึงอีเมลจาก mail server ได้ ต่างจาก **Post Office Protocol (POP3)** ที่ IMAP อนุญาตให้จัดการอีเมลออนไลน์โดยตรงบน server และรองรับโครงสร้างโฟลเดอร์ ดังนั้น IMAP จึงเป็นโปรโตคอลเครือข่ายสำหรับการจัดการอีเมลออนไลน์บน remote server โปรโตคอลนี้เป็นแบบ client-server และอนุญาตให้ซิงค์โครไนซ์ local email client กับ mailbox บน server โดยให้บริการแบบระบบไฟล์เครือข่ายสำหรับอีเมล ทำให้สามารถซิงค์โครไนซ์ได้อย่างไร้ปัญหาผ่านหลาย client ที่เป็นอิสระต่อกัน

ในทางตรงกันข้าม POP3 ไม่มีฟังก์ชันเหมือน IMAP และมีเพียงฟังก์ชันการแสดงรายการ การดึงข้อมูล และการลบอีเมลบน email server เท่านั้น ดังนั้น โปรโตคอลเช่น IMAP จึงต้องถูกใช้สำหรับฟังก์ชันเพิ่มเติม เช่น mailbox แบบลำดับชั้นโดยตรงที่ mail server, การเข้าถึงหลาย mailbox ในระหว่างเซสชันเดียว และการคัดเลือกอีเมลล่วงหน้า

## ความแตกต่างระหว่าง IMAP และ POP3

**IMAP:**
- Client เข้าถึงโครงสร้างเหล่านี้ออนไลน์และสามารถสร้างสำเนาในเครื่องได้
- ผลลัพธ์คือฐานข้อมูลที่เป็นเอกภาพแม้ว่าจะใช้หลาย client
- อีเมลจะยังคงอยู่บน server จนกว่าจะถูกลบ
- เป็นแบบข้อความและมีฟังก์ชันขยาย เช่น การเรียกดูอีเมลโดยตรงบน server
- ผู้ใช้หลายคนสามารถเข้าถึง email server พร้อมกันได้
- หากไม่มีการเชื่อมต่อที่ใช้งานอยู่กับ server จะไม่สามารถจัดการอีเมลได้
- บาง client มี offline mode พร้อมสำเนาเฉพาะที่ของ mailbox โดย client จะซิงค์การเปลี่ยนแปลง offline ทั้งหมดเมื่อสร้างการเชื่อมต่ออีกครั้ง

**การเชื่อมต่อ:**
- Client สร้างการเชื่อมต่อกับ server ผ่าน **พอร์ต 143**
- สำหรับการสื่อสาร ใช้คำสั่งแบบข้อความในรูปแบบ ASCII
- สามารถส่งคำสั่งหลายคำสั่งติดต่อกันได้โดยไม่ต้องรอการยืนยันจาก server
- การยืนยันจาก server ในภายหลังสามารถกำหนดให้กับคำสั่งแต่ละคำได้โดยใช้ตัวระบุที่ส่งไปพร้อมกับคำสั่ง
- ทันทีหลังจากสร้างการเชื่อมต่อ ผู้ใช้จะถูกยืนยันตัวตนด้วยชื่อผู้ใช้และรหัสผ่านไปยัง server
- การเข้าถึง mailbox ที่ต้องการจะเป็นไปได้หลังจากการยืนยันตัวตนสำเร็จเท่านั้น

## การใช้งานร่วมกับ SMTP

**SMTP** มักใช้เพื่อส่งอีเมล ด้วยการคัดลอกอีเมลที่ส่งไปยัง IMAP folder ทำให้ทุก client สามารถเข้าถึงอีเมลที่ส่งทั้งหมดได้ ไม่ว่าจะส่งจากคอมพิวเตอร์เครื่องใด 

ข้อดีอีกประการหนึ่งของ Internet Message Access Protocol คือการสร้างโฟลเดอร์ส่วนตัวและโครงสร้างโฟลเดอร์ใน mailbox ฟีเจอร์นี้ทำให้ mailbox ชัดเจนและจัดการได้ง่ายขึ้น อย่างไรก็ตาม ความต้องการพื้นที่จัดเก็บบน email server จะเพิ่มขึ้น

## การเข้ารหัส

หากไม่มีมาตรการเพิ่มเติม IMAP จะทำงานแบบไม่เข้ารหัสและส่งคำสั่ง อีเมล หรือชื่อผู้ใช้และรหัสผ่านเป็นข้อความธรรมดา Email server หลายตัวต้องการให้สร้างเซสชัน IMAP แบบเข้ารหัสเพื่อให้มีความปลอดภัยมากขึ้นในการรับส่งอีเมลและป้องกันการเข้าถึง mailbox โดยไม่ได้รับอนุญาต โดยปกติจะใช้ **SSL/TLS** สำหรับวัตถุประสงค์นี้ ขึ้นอยู่กับวิธีการและการนำไปใช้ การเชื่อมต่อแบบเข้ารหัสจะใช้พอร์ตมาตรฐาน **143** หรือพอร์ตทางเลือก เช่น **993**

## การตั้งค่าเริ่มต้น (Default Configuration)

ทั้ง IMAP และ POP3 มีตัวเลือกการตั้งค่าจำนวนมาก ทำให้ยากที่จะศึกษาแต่ละส่วนประกอบอย่างละเอียด หากต้องการตรวจสอบการตั้งค่าโปรโตคอลเหล่านี้อย่างลึกซึ้ง แนะนำให้สร้าง VM ในเครื่องและติดตั้งแพ็กเกจ **dovecot-imapd** และ **dovecot-pop3d** โดยใช้ apt แล้วทดลองกับการตั้งค่าต่างๆ

ในเอกสารของ Dovecot เราสามารถค้นหาการตั้งค่าหลักแต่ละรายการและตัวเลือกการตั้งค่าบริการที่สามารถใช้สำหรับการทดลองของเราได้ อย่างไรก็ตาม มาดูรายการคำสั่งและดูว่าเราสามารถโต้ตอบและสื่อสารกับ IMAP และ POP3 โดยใช้ command line ได้อย่างไร

## คำสั่ง IMAP

| คำสั่ง | คำอธิบาย |
|--------|----------|
| **1 LOGIN username password** | เข้าสู่ระบบของผู้ใช้ |
| **1 LIST "" *** | แสดงรายการไดเรกทอรีทั้งหมด |
| **1 CREATE "INBOX"** | สร้าง mailbox ด้วยชื่อที่ระบุ |
| **1 DELETE "INBOX"** | ลบ mailbox |
| **1 RENAME "ToRead" "Important"** | เปลี่ยนชื่อ mailbox |
| **1 LSUB "" *** | ส่งคืนชุดย่อยของชื่อจากชุดชื่อที่ผู้ใช้ประกาศว่ากำลังใช้งานหรือสมัครสมาชิก |
| **1 SELECT INBOX** | เลือก mailbox เพื่อให้สามารถเข้าถึงข้อความใน mailbox ได้ |
| **1 UNSELECT INBOX** | ออกจาก mailbox ที่เลือก |
| **1 FETCH <ID> all** | ดึงข้อมูลที่เกี่ยวข้องกับข้อความใน mailbox |
| **1 CLOSE** | ลบข้อความทั้งหมดที่มีการตั้งค่าแฟล็ก Deleted |
| **1 LOGOUT** | ปิดการเชื่อมต่อกับ IMAP server |

## คำสั่ง POP3

| คำสั่ง | คำอธิบาย |
|--------|----------|
| **USER username** | ระบุตัวตนผู้ใช้ |
| **PASS password** | การยืนยันตัวตนของผู้ใช้โดยใช้รหัสผ่าน |
| **STAT** | ขอจำนวนอีเมลที่บันทึกไว้จาก server |
| **LIST** | ขอจำนวนและขนาดของอีเมลทั้งหมดจาก server |
| **RETR id** | ขอให้ server ส่งอีเมลที่ร้องขอตาม ID |
| **DELE id** | ขอให้ server ลบอีเมลที่ร้องขอตาม ID |
| **CAPA** | ขอให้ server แสดงความสามารถของ server |
| **RSET** | ขอให้ server รีเซ็ตข้อมูลที่ส่ง |
| **QUIT** | ปิดการเชื่อมต่อกับ POP3 server |

## การตั้งค่าที่เป็นอันตราย (Dangerous Settings)

อย่างไรก็ตาม ตัวเลือกการตั้งค่าที่ตั้งค่าไม่ถูกต้องอาจทำให้เราได้รับข้อมูลเพิ่มเติม เช่น การดีบักคำสั่งที่รันบนบริการ หรือเข้าสู่ระบบแบบ anonymous คล้ายกับบริการ FTP 

บริษัทส่วนใหญ่ใช้ผู้ให้บริการอีเมลบุคคลที่สาม เช่น Google, Microsoft และอื่นๆ อีกมากมาย อย่างไรก็ตาม บริษัทบางแห่งยังคงใช้ mail server ของตัวเองด้วยเหตุผลหลายประการ หนึ่งในเหตุผลเหล่านี้คือการรักษาความเป็นส่วนตัวที่พวกเขาต้องการเก็บไว้ในมือของตัวเอง 

ผู้ดูแลระบบสามารถทำข้อผิดพลาดในการตั้งค่าได้มากมาย ซึ่งในกรณีที่เลวร้ายที่สุดจะทำให้เราสามารถอ่านอีเมลทั้งหมดที่ส่งและรับได้ ซึ่งอาจรวมถึงข้อมูลที่เป็นความลับหรือข้อมูลที่ละเอียดอ่อน 

### การตั้งค่าที่เป็นอันตราย:

| การตั้งค่า | คำอธิบาย |
|-----------|----------|
| **auth_debug** | เปิดใช้งานการบันทึกดีบักการยืนยันตัวตนทั้งหมด |
| **auth_debug_passwords** | การตั้งค่านี้ปรับความละเอียดของ log รหัสผ่านที่ส่ง และ scheme จะถูกบันทึก |
| **auth_verbose** | บันทึกความพยายามในการยืนยันตัวตนที่ไม่สำเร็จและเหตุผล |
| **auth_verbose_passwords** | รหัสผ่านที่ใช้สำหรับการยืนยันตัวตนจะถูกบันทึก และยังสามารถถูกตัดทอนได้ |
| **auth_anonymous_username** | ระบุชื่อผู้ใช้ที่จะใช้เมื่อเข้าสู่ระบบด้วยกลไก ANONYMOUS SASL |

